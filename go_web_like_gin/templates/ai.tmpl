{{ define "ai.tmpl" }}
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ .title }}</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<header>
  <h1>ğŸ¤– {{ .title }}</h1>
  <nav><a href="/">â† è¿”å›</a></nav>
</header>
<main>
  <div class="chat">
    <ul id="history">
      {{ range .history }}
      <li>{{ . }}</li>
      {{ else }}
      <li class="muted">è¿˜æ²¡æœ‰å¯¹è¯ï¼Œå…ˆæ‰“ä¸ªæ‹›å‘¼å§ï½</li>
      {{ end }}
    </ul>
    <form id="chat-form">
      <input type="text" id="q" name="q" placeholder="å‘ Dipperick çš„ AI åŠ©æ‰‹æé—®â€¦" autocomplete="off" required />
      <div style="display:flex; gap:8px">
        <button type="submit">å‘é€</button>
        <button id="clear" type="button" class="secondary">æ¸…ç©ºå¯¹è¯</button>
      </div>
    </form>
  </div>
</main>
<script>
const form = document.getElementById('chat-form');
const input = document.getElementById('q');
const history = document.getElementById('history');
const clearBtn = document.getElementById('clear');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const q = input.value.trim();
  if (!q) return;
  history.insertAdjacentHTML('beforeend', `<li>ä½ : ${q}</li>`);
  input.value = '';
  try {
    const resp = await fetch('/api/ai/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ q })
    });
    const data = await resp.json();
    if (data.error) {
      history.insertAdjacentHTML('beforeend', `<li class="error">é”™è¯¯ï¼š${data.error}</li>`);
    } else {
      history.insertAdjacentHTML('beforeend', `<li>åŠ©æ‰‹: ${data.answer}</li>`);
    }
    history.scrollTop = history.scrollHeight;
  } catch (err) {
    history.insertAdjacentHTML('beforeend', `<li class="error">ç½‘ç»œé”™è¯¯</li>`);
  }
});

clearBtn.addEventListener('click', async () => {
  try {
    await fetch('/api/ai/reset', { method: 'POST' });
    history.innerHTML = '<li class="muted">å¯¹è¯å·²æ¸…ç©ºã€‚</li>';
  } catch (err) {
    history.insertAdjacentHTML('beforeend', `<li class="error">æ¸…ç©ºå¤±è´¥</li>`);
  }
});
</script>
</body>
</html>
{{ end }}
